<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code testing tool</title>
</head>
<body style="margin:0">
  <button onclick="clear_localstorage();">Clear localStorage</button>
  <input type="file" name="" id="file_input">
  <span>URL: </span>
  <input type="text" name="" id="activity_url">
  <button onclick="run_tests();">Run Tests</button>
  <button onclick="get_results();">Get Results</button>
  <iframe id="sim_iframe" style="margin:0;width:100%;height:100vh" src="./index.html" frameborder="0" sandbox="allow-modals allow-scripts allow-same-origin" ></iframe>
  <script src="assets/js/z-worker.js"></script>
  <script src="assets/js/zip.min.js"></script>
  <script>
    var files = [];
    async function unzip(file){
      const reader = new zip.ZipReader(new zip.BlobReader(file));
      const entries = await reader.getEntries();
      for (let i = 0; i < entries.length; i++) {
        const element = entries[i];
        const name = element.filename.replaceAll(" ", "_").replaceAll("/", "_");
        if(element.directory) continue;
        const blob = await element.getData(new zip.BlobWriter(['application/binary']));
        files.push(new File([blob], name));
        console.log(name);
        if(!localStorage.getItem(name)){
          localStorage.setItem(name,"");
        }
      }
      // close the ZipReader
      await reader.close();
    }
    
    file_input.onchange = function () {
      unzip(file_input.files[0]);
    }

    function clear_localstorage() {
      localStorage.clear();
    }

    var sleep = (milliseconds) => {
      return new Promise(resolve => setTimeout(resolve, milliseconds));
    };

    async function run_test(file){
      sim_iframe.src = activity_url.value;
      setTimeout(function () {
        sim_iframe.contentWindow.postMessage({cmd: {op: "load_files_from_array", params: [file]}});
        sim_iframe.contentWindow.postMessage({cmd: {op: "start_assistant", params: {}}});
      }, 3000);
      return new Promise(resolve => {
        finish_test_cb = resolve;
        setTimeout(resolve, 60000);
      });
    }

    var finish_test_cb = _ => {};
    var test_log = {log: []};
    async function run_tests(){
      for (let i = 0; i < files.length; i++) {
        const element = files[i];
        test_log = {log: []}
        if(localStorage.getItem(element.name) === ""){
          test_log["filename"] = element.name;
          await run_test(element);
          sim_iframe.contentWindow.location.reload();
          localStorage.setItem(element.name, JSON.stringify(test_log));
          await sleep(3000);
        }
      }
    }

    function download(filename, text) {
      var element = document.createElement('a');
      var url = URL.createObjectURL( new Blob( [text], {type:'text/plain'} ) );
      element.setAttribute('href', url);
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
      URL.revokeObjectURL(url);
    }

    function get_results() {
      let all_results = []
      for (var i = 0; i < localStorage.length; i++){
        const str = localStorage.getItem(localStorage.key(i));
        if(str != "") all_results.push(JSON.parse(str));
      }
      download("test_results.json", JSON.stringify(all_results));
    }

    function test() {
      sim_iframe.contentWindow.postMessage({cmd: {op: "load_file"}});
    }
    function test2() {
      sim_iframe.contentWindow.postMessage({cmd: {op: "echo", params: "oi"}});
    }
    onmessage = function name(data) {
      if(data.data.finish_test) {
        test_log["comment"] = data.data.comment;
        test_log["grade"] = data.data.grade;
        finish_test_cb();
      }else{
        test_log.log.push(data.data);
      }
    }
  </script>
</body>
</html>